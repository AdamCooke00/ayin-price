<!DOCTYPE html>
<html>

<head>
   <title>Ayin DEX price tracker</title>
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>

   <style>
      body {
         margin: 0;
         position: absolute;
         top: 50%;
         left: 50%;
         margin-right: -50%;
         transform: translate(-50%, -50%);
         font-family: Consolas;
      }
   </style>
   <script>

      const ALPH_DECIMALS = 18;
      const EXPLORER_BASEURL = "https://explorer.mainnet.alephium.org"
      const tokenList = [
         {
            tokenid:
               "1a281053ba8601a658368594da034c2e99a0fb951b86498d05e76aedfe666800",
            contractid: "25ywM8iGxKpZWuGA5z6DXKGcZCXtPBmnbQyJEsjvjjWTy",
            symbol: "AYIN",
            decimals: 18,
         },
         {
            tokenid:
               "b522184377a33e376e997a950288fa76c1f48e97bc29cd10779adc7cfb673200",
            contractid: "w5ZU1rV34YJryDCXCXJBXA77Wbx5L4DCmunDG3Pn5GWb",
            symbol: "BERRY",
            decimals: 0,
         },
         {
            tokenid:
               "66da610efb5129c062e88e5fd65fe810f31efd1597021b2edf887a4360fa0800",
            contractid: "22PUN5TpytzGRXZnzkHViRaWioiGNzdufJH1CxFyQF5Sf",
            symbol: "ALF",
            decimals: 9,
         },
         {
            tokenid:
               "b2d71c116408ae47b931482a440f675dc9ea64453db24ee931dacd578cae9002",
            contractid: "27wpryy3RtEYLnkuF2xgPKQfcYAxWY4mFxaM8XHpXndfD",
            symbol: "PACA",
            decimals: 0,
         },
         {
            tokenid:
               "1516c410b54470d667e1315ce2faa81870c76c5c7a491e3e86eeec8366495502",
            contractid: "tx1Uck1idLzfyjAbyqrFkNWrxz1MfKCV5FELnJdtbVUs",
            symbol: "TAIL",
            decimals: 0,
         },
      ];

      document.addEventListener("DOMContentLoaded", function (event) {

         textPrice()

               document.getElementById("loading").innerHTML = "";
      });

      async function textPrice() {
         const tokenListElement = document.getElementById("tokenlist")
	 const alphUsd = await getAlphUsd()
         var counterLoaded = 0

         Object.entries(tokenList).forEach(async (entry) => {
            const [key, value] = entry
            var price = ""
            var priceText = ""
            try {
               price = await getPrice(
                  value["contractid"],
                  value["tokenid"],
                  value["decimals"]
               );
	       alphBalance = price[0]
	       tokenBalance = price[1]
	       pricePerAlph = alphBalance/tokenBalance
            priceText = "1 " + value["symbol"] + " = " + (pricePerAlph).toFixed(6) + " ALPH ($"+(pricePerAlph * alphUsd).toFixed(4)+")"
            } catch (err) {
               console.error(err);
               price = "error, cannot fetch price";
            }
	    
            const explorerLink = EXPLORER_BASEURL + '/addresses/' + value['contractid']

            const heading = document.createElement("h4")
            const div = document.createElement("div")

            heading.innerHTML = "<a target='_blank' rel='noopener noreferrer' title=" + explorerLink + " href=" + explorerLink + ">" + "ALPH - " + value["symbol"] + "</a>"

            const para = document.createElement("p");
            para.innerHTML = priceText

            div.appendChild(heading);
            div.appendChild(para);
            tokenListElement.appendChild(div);

         });


      }

      function updateSelection(autoUpdateCheckBox) {
         if (autoUpdateCheckBox.checked) {
            textPrice()
            console.log("update")
            intervalUpdate = setInterval(textPrice, 3000);
         }
         else {
            if (typeof intervalUpdate !== 'undefined')
               clearInterval(intervalUpdate);
         }
      };

      async function getPrice(contractid, tokenid, decimals) {
         const price = await Promise.all([
            await fetch(
               "https://backend.mainnet.alephium.org/addresses/" +
               contractid +
               "/tokens/" +
               tokenid +
               "/balance"
            ).then((resp) => resp.json()),
            await fetch(
               "https://backend.mainnet.alephium.org/addresses/" +
               contractid +
               "/balance"
            ).then((resp) => resp.json()),
         ]).then((allResponses) => {
            tokenBalance =
               parseFloat(allResponses[0]["balance"]) / Math.pow(10, decimals);
            alphBalance =
               parseFloat(allResponses[1]["balance"]) /
               Math.pow(10, ALPH_DECIMALS);

            return new Promise((resolve, reject) => {
               resolve([alphBalance, tokenBalance]);
            });
         });

         return price;
      }
     
     async function getAlphUsd(){

         const priceUsd = await Promise.all([
            await fetch(
            "https://api.coingecko.com/api/v3/simple/price?ids=alephium&vs_currencies=usd").then((resp) => resp.json()),
         ]).then((allResponses) => {
            return new Promise((resolve, reject) => {
               resolve(allResponses[0]['alephium']['usd']);
            });
         });

         return priceUsd;
     }

   </script>

   <!--<input type="checkbox" id="autoUpdate" onchange="updateSelection(this)" > Auto update -->
   <div style="text-align: center;padding-left: 1em;">
   <h1>Prices of AYIN DEX pairs</h1>
   <p id="loading">Loading...</p>
   <div id="tokenlist"></div>
   </div>
</body>

</html>
